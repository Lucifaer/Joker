package com.lucifaer.jokerframework.joker.core.factory;

import com.lucifaer.jokerframework.joker.core.utils.GetRealPath;
import com.lucifaer.jokerframework.joker.core.utils.PluginScanner;
import com.lucifaer.jokerframework.sdk.model.ExploitModel;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;

import java.util.Map;

/**
 * @author Lucifaer
 * @version 1.0.0.RELEASE
 * @since 2020/6/3
 */
@Component
public class ExploitFactory extends BaseFactory<ExploitModel> {
    private static final Logger log = LoggerFactory.getLogger(ExploitFactory.class);

    public ExploitFactory() {
        setExistMap(getExistExploitPlugins());
    }

    private Map<String, ExploitModel> getExistExploitPlugins() {
        PluginScanner<ExploitModel> pluginScanner = new PluginScanner<>();
        String filePath = GetRealPath.getPath("exploit");
        Map<String, ExploitModel> exploitPlugins = pluginScanner.pluginsScan(filePath);
//        Map<String, ExploitModel> exploitPlugins = pluginScanner.pluginsScan("${pwd}/JokerExploitLib/Weblogic/cve-2020-2555(12_2_1_3)/build/libs/");

        log.info("Plugin Directory is: " + filePath);
        if (!exploitPlugins.isEmpty()) {
            log.info("======================= Loading Plugins =========================");
            for (String pluginName : exploitPlugins.keySet()) {
                log.info("[+] " + pluginName + " is loaded");
            }
            log.info("=================== Plugins loading successful ==================");
        }
        else {
            log.warn("There have no exploit plugins at " + filePath + ". Please check whether the directory is correct!");
        }
        return exploitPlugins;
    }
}
